"""Auto-generated primitives for ilo communication"""

import inspect
from functools import wraps
from typing import get_type_hints


def _typecheck(func):
    hints = get_type_hints(func)
    sig = inspect.signature(func)

    @wraps(func)
    def wrapper(*args, **kwargs):
        bound = sig.bind_partial(*args, **kwargs)
        bound.apply_defaults()

        for name, value in bound.arguments.items():
            if name not in hints:
                continue

            expected = hints[name]

            if not isinstance(value, expected):
                raise TypeError(
                    f"Parameter '{name}' of '{func.__name__}' must be {expected.__name__}, "
                    f"got {type(value).__name__}"
                )

        return func(*args, **kwargs)

    return wrapper


{% set type_map = {
    "boolean": "bool",
    "integer": "int",
    "string": "str",
    "float": "float"
} %}

{% for t in trames %}
@_typecheck
def {{ t.name }}(
    {%- for p in t.parameters -%}
        {{- p.name -}}: {{ type_map[p.type] }}
        {%- if not loop.last -%}, {% endif %}
    {%- endfor -%}
) -> str:
    {% if t.doc %}
    """{{ t.doc }}"""
    {% else %}
    """Primitive for {{ t.name }}"""
    {% endif %}
    return f"{% for i in range(t.trame_parts|length) %}
        {{- t.trame_parts[i] | escape_fstring -}}
        {% if i < t.parameters|length %}
            {{- '{' ~ t.parameters[i].name ~ '}' -}}
        {% endif %}
    {% endfor %}"
    {%- if not loop.last -%}
      {{- '\n\n' -}}
    {% else %}
      {{- '\n' -}}
    {% endif %}
{% endfor %}


__all__ = (
{% for t in trames %}
  "{{ t.name }}",
{% endfor %}
)
